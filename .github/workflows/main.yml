name: Link Check (No Token, Strict)

on:
  push:
  pull_request:

jobs:
  link-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Rust and install Lychee
        run: |
          echo "ü¶Ä Instalando Rust e Lychee..."
          sudo apt-get update && sudo apt-get install -y curl
          cargo install lychee

      - name: Run Lychee and generate report
        run: |
          echo "üîç Executando verifica√ß√£o de links com Lychee..."
          mkdir -p reports
          lychee --output reports/relatorio-links-quebrados.md ./public || true
          echo "üìÑ Conte√∫do do relat√≥rio:"
          cat reports/relatorio-links-quebrados.md || true

      - name: Check for broken links (simulate issue creation, then fail)
        run: |
          echo "üì¶ Verificando se h√° links quebrados..."
          if grep -q '‚úó' reports/relatorio-links-quebrados.md; then
            echo "‚ö†Ô∏è Links quebrados encontrados."

            # Monta um payload JSON simulando a issue que criar√≠amos
            TITLE="Links quebrados detectados no site"
            DESCRIPTION="$(sed 's/\"/\\"/g' reports/relatorio-links-quebrados.md | awk '{printf "%s\\n", $0}')"
            PAYLOAD=$(printf '{"title":"%s","description":"%s","labels":"automated,broken-links"}' "$TITLE" "$DESCRIPTION")

            echo "üßæ Simula√ß√£o de payload para cria√ß√£o de issue (nenhuma chamada externa ser√° feita):"
            echo "$PAYLOAD"

            echo "‚ùå Falha intencional: links quebrados detectados. Encerrando job."
            exit 1
          else
            echo "‚úÖ Nenhum link quebrado encontrado."
          fi
